name: Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to Staging and Production
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Install cf client
      run: |
        wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
        echo 'deb https://packages.cloudfoundry.org/debian stable main' | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
        sudo apt-get -qq update
        sudo apt-get install cf7-cli
    - name: Deploy to staging
      env:
        SPACE: staging
        APP_NAME: cosmetics-web
        SUBMIT_HOST: staging-submit.cosmetic-product-notifications.service.gov.uk
        SEARCH_HOST: staging-search.cosmetic-product-notifications.service.gov.uk
        CF_USERNAME: ${{ secrets.PaaSUsernameInt }}
        CF_PASSWORD: ${{ secrets.PaaSPasswordInt }}
      run: |
        cf api api.london.cloud.service.gov.uk
        cf auth
        cf target -o 'beis-opss' -s $SPACE
        ./cosmetics-web/deploy.sh
        cf logout
    - name: Deploy to production
      env:
        SPACE: production
        APP_NAME: cosmetics-web
        SUBMIT_HOST: submit.cosmetic-product-notifications.service.gov.uk
        SEARCH_HOST: search.cosmetic-product-notifications.service.gov.uk
        CF_USERNAME: ${{ secrets.PaaSUsernameInt }}
        CF_PASSWORD: ${{ secrets.PaaSPasswordInt }}
      run: |
        cf api api.london.cloud.service.gov.uk
        cf auth
        cf target -o 'beis-opss' -s $SPACE
        ./cosmetics-web/deploy.sh
        cf logout
