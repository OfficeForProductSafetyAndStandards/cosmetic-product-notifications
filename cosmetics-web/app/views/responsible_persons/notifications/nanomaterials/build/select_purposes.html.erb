<%
  predefined_purposes = NanoElementPurposes.predefined
  predefined_purposes_items = predefined_purposes.map do |purpose|
    { key: purpose.name,
      text: purpose.upcase_display_name,
      checked: @nano_element.purposes&.include?(purpose.name) }
  end
%>

<% page_title("Select nanomaterial purpose", errors: @nano_element.errors.messages.include?(:purposes)) %>
<% content_for :after_header do %>
  <%= govukBackLink text: "Back", href: responsible_person_notification_draft_path(@notification.responsible_person, @notification) %>
<% end %>

<%= form_with(model: @nano_element, url: wizard_path, method: :put) do |form| %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <% if @nano_element.errors.messages.include?(:purposes) %>
        <%= govukErrorSummary(titleText: "There is a problem",
                              errorList: [{text: @nano_element.errors.messages[:purposes][0],
                              href: "#nano_element_colorant"}] ) %>
      <% end %>
      <% predefined_purposes_checkboxes_html = capture do %>
        <%= govukCheckboxes(
              form: form,
              key: :purposes,
              fieldset: { legend: { text: "Select all that apply", isPageHeading: false } },
              items: predefined_purposes_items,
            ) %>
      <% end %>
      <%= govukRadios(
            form: form,
            key: :purpose_type,
            fieldset: { legend: { text: "What is the purpose of this nanomaterial?",
                                  classes: "govuk-label--l",
                                  isPageHeading: true } },
            items: [{ text: to_sentence(predefined_purposes.map(&:upcase_display_name), last_word_connector: " or "),
                      value: "predefined",
                      conditional: { html: predefined_purposes_checkboxes_html } },
                    { text: NanoElementPurposes.other.upcase_display_name,
                      value: NanoElementPurposes.other.name }]
          ) %>
      <%= govukButton text: "Continue" %>
    </div>
  </div>
<% end %>
