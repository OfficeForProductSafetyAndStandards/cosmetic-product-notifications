<% title = "Add the ingredients" %>

<% page_title title, errors: @ingredient_concentration_form.errors.any? %>
<% content_for :after_header do %>
  <%= govukBackLink text: "Back", href: previous_wizard_path %>
<% end %>

<% errors = @ingredient_concentration_form.errors %>
<%= error_summary(errors,
                  %i[name cas_number exact_concentration range_concentration],
                  map_errors: { range_concentration: ingredient_range_concentration_items.first[:id] }) %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l govuk-!-margin-bottom-3"><%= title %></h1>
  </div>

  <div class="govuk-grid-column-two-thirds">
    <p class="govuk-body-s opss-secondary-text">For every ingredient:</p>
    <ul class="govuk-list govuk-list--bullet govuk-!-font-size-16 opss-secondary-text">
      <li>Use the International Nomenclature of Cosmetic Ingredients (<abbr>INCI</abbr>) name, where available</li>
      <li>Confirm if poisonous - especially if the details match ingredients listed in the following poison tables </li>
    </ul>

    <%= govukDetails(summaryText: "Show the poison tables", classes: "govuk-!-margin-left-0 govuk-!-font-size-16") do %>
      <%= render "poison_tables" %>
    <% end %>

    <hr class="govuk-section-break govuk-section-break--visible govuk-!-margin-top-0 govuk-!-margin-bottom-6">

    <%= form_with model: @ingredient_concentration_form, scope: :ingredient_concentration_form, url: wizard_path, method: :put, html: { novalidate: true } do |form| %>
      <div class="govuk-form-group">
        <%= render "components/govuk_fieldset", legend: { text: "Ingredient #{@component.ingredients.count + 1}", classes: "govuk-fieldset__legend--s" } do %>
          <%= render "form_components/govuk_input", form: form, id: "name", key: :name, label: { text: "What is the name?" } %>
          <%= render "form_components/govuk_input",
                    form: form,
                    key: :cas_number,
                    id: "cas_number",
                    label: { text: "What is the CAS number?", classes: "govuk-label--s govuk-!-font-weight-regular" },
                    classes: "govuk-input--width-10" %>

          <% exact_concentration_html = capture do %>
              <% concentration_error = @ingredient_concentration_form.errors[:exact_concentration]&.first %>
              <div class="govuk-form-group <%= "govuk-form-group--error" if concentration_error %>">
                <%= govukLabel(for: :exact_concentration, text: "What is the exact concentration?", classes: "govuk-label--s govuk-!-font-weight-regular")%>
                <% if concentration_error %>
                  <%= render "components/govuk_error_message", id: "exact_concentration-error", text: concentration_error %>
                <% end %>
                <div class="govuk-input__wrapper">
                  <%= form.text_field(:exact_concentration,
                                      id: "exact_concentration",
                                      class: "govuk-input govuk-input--width-3 #{'govuk-input--error' if concentration_error}",
                                      maxlength: 3,
                                      "aria-describedby" => ("exact_concentration-error" if concentration_error)) %>
                  <div class="govuk-input__suffix" aria-hidden="true">
                    <span title="Percentage weight by weight">% w/w</span>
                  </div>
                </div>
              </div>
          <% end %>

          <% range_concentration_html = capture do %>
            <%= render "form_components/govuk_radios",
                       form: form,
                       key: :range_concentration,
                       classes: "govuk-radios--small",
                       fieldset: { legend: { text: "What is the concentration range?",
                                             classes: "govuk-fieldset__legend--s govuk-!-font-weight-regular",
                                             isPageHeading: false } },
                       items: ingredient_range_concentration_items %>
          <% end %>

          <%= render "form_components/govuk_radios",
                     form: form,
                     key: :poisonous,
                     id: "poisonous",
                     fieldset: { legend: { text: "Is it poisonous?",
                                           classes: "govuk-fieldset__legend--s govuk-!-font-weight-regular",
                                           isPageHeading: false } },
                     items: [
                       { text: "Yes",
                         value: "true",
                         id: "poisonous_true",
                         conditional: { html: exact_concentration_html },
                         checked: errors.include?(:exact_concentration) || form.object.exact? },
                       { text: "No",
                         value: "false",
                         id: "poisonous_false",
                         conditional: { html: range_concentration_html },
                         checked: errors.include?(:range_concentration) || form.object.range? },
                     ] %>
        <% end %>
      </div>
      <div class="govuk-button-group">
        <%= govukButton text: "Save and continue" %>
        <% if @component.ingredients.any? %>
          <%= link_to("Skip", wizard_path(:select_ph_option), class: "govuk-link govuk-link--no-visited-state") %>
        <% end %>
      </div>
    <% end %>
  </div>
  <% if @component.ingredients.any? %>
    <div class="govuk-grid-column-one-third">
      <h2 class="govuk-heading-s">Already added</h2>

      <ol class="govuk-list govuk-list--number govuk-!-font-size-16 opss-secondary-text">
        <% @component.ingredients.each do |ingredient| %>
          <li><%= ingredient.inci_name %></li>
        <% end %>
      </ol>

      <p class="govuk-body-s opss-secondary-text">
        These ingredients have already been added to the <%= @component.notification.is_multicomponent? ? "item" : "product" %>.
      </p>
    </div>
  <% end %>
</div>
