<% title = "Upload ingredients file" %>
<% page_title title, errors: @component.errors.any? %>
<% content_for :after_header do %>
  <%= govukBackLink text: "Back", href: previous_wizard_path %>
<% end %>

<%= form_with model: @component, url: wizard_path, method: :put do |form| %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <% if @component.ingredients_file.attached? %>
        <% file = @component.ingredients_file %>
        <table class="govuk-table" id="formulation-files-table">
          <caption class="govuk-table__caption govuk-heading-m">
Upload a file <span class="govuk-!-font-weight-regular govuk-!-font-size-16"> &ndash; Uploading another file will add more ingredients.</span>
</caption>
          <tbody class="govuk-table__body">
            <tr class="govuk-table__row">
              <th class="govuk-table__header govuk-!-width-two-thirds" scope="row">
                <%= link_to(file.filename, url_for(file), class: "govuk-link govuk-link--no-visited-state") %>
              </th>
              <td class="govuk-table__cell">
              </td>
            </tr>
          </tbody>
        </table>
      <% end %>
      <div class="govuk-form-group <%= error_group_class(@component)%>">
          <p>File type must be a CSV.</p>

          <%= form.label :ingredients_file, "Upload a file", class: "govuk-label govuk-label--s" %>
          <% if @component.errors.any? %>
            <span id="file-upload-1-error" class="govuk-error-message">
              <span class="govuk-visually-hidden">Error:</span> Upload a list of ingredients
            </span>
          <% end %>
          <% if @creator && !@creator.valid? %>
            <span id="file-upload-2-error" class="govuk-error-message">
              <span class="govuk-visually-hidden">Problems</span>One or more lines in CSV file are incorrect 
            </span>
            <% @creator.ingredients.each do |ingredient| %>
              <p>
              Error in line <code><%= ingredient.line_number %></code>: <code><%= ingredient.line %></code> 
              </p>
              <%= error_summary(ingredient.errors) %>
            <% end %>
          <% end %>
          <%= form.file_field :ingredients_file, class: "govuk-file-upload",
                  accept: "csv" %>
      </div>
    </div>
  </div>
  <%= govukButton text: "Continue" %>
<% end %>
