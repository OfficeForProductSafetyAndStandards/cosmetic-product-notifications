---
applications:
- name: ((app-name))
  buildpacks:
    - ruby_buildpack
  routes:
    - route: ((search-host))
    - route: ((submit-host))
  env:
    SEARCH_HOST: ((search-host))
    SUBMIT_HOST: ((submit-host))
    COSMETICS_HOST: ((submit-host))
  stack: cflinuxfs3
  services:
    - cosmetics-database
    - cosmetics-elasticsearch
    - cosmetics-queue
    - opss-log-drain
    - cosmetics-aws-env
    - cosmetics-auth-env
    - cosmetics-health-env
    - cosmetics-keycloak-env
    - cosmetics-rails-env
    - cosmetics-sentry-env
    - cosmetics-notify-env
    - cosmetics-sidekiq-env
    - cosmetics-antivirus-env
  path: .
  command: export $(./env/get-env-from-vcap.sh) && STATEMENT_TIMEOUT=60s bin/rake cf:on_first_instance db:migrate && bin/rails server -b 0.0.0.0 -p $PORT -e $RAILS_ENV
  processes:
    - type: web
      command: export $(./env/get-env-from-vcap.sh) && STATEMENT_TIMEOUT=60s bin/rake cf:on_first_instance db:migrate &&  bin/rails server -b 0.0.0.0 -p $PORT -e $RAILS_ENV
      instances: 1
      memory: 1G
    - type: worker
      command: export $(./env/get-env-from-vcap.sh) && bin/yarn install && bin/sidekiq -C config/sidekiq.yml
      health-check-type: process
      instances: 1
      memory: 500M
